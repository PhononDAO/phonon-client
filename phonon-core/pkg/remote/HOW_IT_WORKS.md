# How The Remote protocol works
## Why this document? 
This document is to clarify how the remote protocol currently works to facilitate better discussion on how to better improve it and work on it in the future. This can be replaced or supplemented by another remote protocol, but this is (at time of writing) the cannonical phonon remote protocol

## Connection and communication with jumpbox
Connections are created when the Connect function is called with a session object and a phonon url. A RemoteConnection object is created, and a connection is established to the jumpbox server. 

The connection is an http2 2-way relay with full duplex connection using gob encoding to send messages.
The full duplex aspect of the connection increases complexety, but is necessary because either side of the connection is a peer, and needs to be able to create and respond to messages from either end at any time. 

Once a connection is initiated, a listener goroutine is started to handle incoming messages, and a data out channel is created to handle passing messages to the jumpbox server.

The client immediately requests the certificate from the connected card's session and sends it to the server. Following this, the client is controlled by both the local client and messages coming from the remote side of the connection. 

## Messages

Here is a table of currently implemented messages

| Message                  | Origin | Client Handling                                 | Server Handling                                        | Runs code on card | Usage                                                                                                                                                                                                     |
|--------------------------|--------|-------------------------------------------------|--------------------------------------------------------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Connected                | none   | unused                                          | unused                                                 | none              | not used. Should be removed                                                                                                                                                                               |
| Disconnected             | Server | Disconnect from server                          | none                                                   | none              | Used to indicate that the client is no longer connected to the server for some reason. Client will set it's state as disconnected                                                                         |
| Error                    | Either | Log error communicating with server             | none                                                   | none              | Indicates an error has occured that needs to be known by the user                                                                                                                                         |
| PassthruFailed           | Server | Log error communicating with paired peer        | none                                                   | none              | Indicates the server was unable to send passthru message to connected peer. Handling is not currently implemented, and will be weird                                                                      |
| IdentifiedWithServer     | Server | Set client state to be connected to server      | None                                                   | none              | Indicates to the client that the server has established communication with the client and is ready for incoming pair requests                                                                             |
| connectedToCard          | Server | Set client session to "connected to card" state | none                                                   | none              | Indicates to both peer clients that the server has linked them together, and passthru type messages will be sent on to the peer if received                                                               |
| Identify                 | Either | Run IdentifyCard command and send back response | passthru after initial identification                  | IdentifyCard      | For validating that the client is who it claims to be it is via challenge.                                                                                                                                |
| IdentifyResponse         | Client | Verify challenge from identify request          | passthru after initial identification                  | none              | To complete the step of validating the client being talked to is who it claims to be                                                                                                                      |
| RequestCert              | Either | Request Client Cert                             | passthru                                               | none              | To get the certificate of the card being requested. This is a cached value held by the session object from initial card to terminal processing                                                            |
| ResponseCert             | Client | Store peer certificate                          | Store client certificate                               | none              | Store client certificate for any and all certificate storage reasons                                                                                                                                      |
| NoOp                     | client | none                                            | none                                                   | none              | was for some higher level session keepalvie. Currently not used. May be deleted at some later time                                                                                                        |
| Connect2Card             | Client | none                                            | Connect card to peer (does not pair)                   | none              | For starting the connection process between two cards                                                                                                                                                     |
| DisconnectFromCard       | Either | Set card connection state to unconnected        | set card connection state on both sides to unconnected | none              | For disconnecting cards from one another. Should be used when all transactions are completed between two cards or when an error is received from one end.                                                 |
| EndSession               | Client | none                                            | cease communication with client                        | none              | For disconnecting a card from the server gracefully                                                                                                                                                       |
| AckPhonon                | client | Set sent phonon as received from remote         | delete cached(unimplemented)phonon packet and passthru | none              | For indicating the recipt of a phonon packet. The server is now able to delete the phonon, and the session that sent the phonon can be reasonably sure it's been received and move on to the next thing.  |
| VerifyPairing            | Client | Ask for pairing status                          | passthru                                               | none              | Request to verify the pairing status of the opposite card. This is just a check to make sure the connection hasn't gone stale.                                                                            |
| VerifyPairingResponse    | Client | Send back pairing status(paired card id)        | passthru                                               | none              | response to the above. Consists of the id of the paired card if applicable. Receiving client should make sure the paired card is itself before attempting to send phonons                                 |
| CardPair1                | Client | Run Card Pair1                                  | passthru                                               | CardPair1         | Run the CardPair operation in the card session and send back the results                                                                                                                                  |
| CardPair1Response        | client | Process CardPair1 Response                      | passthru                                               | none              | Process the results of the above remote operation                                                                                                                                                         |
| CardPair2                | client | Run Card Pair2                                  | passthru                                               | CardPair2         | Run the cardPair2 operation in the card session and send back the results                                                                                                                                 |
| CardPair2Response        | client | Process CardPair2 Response                      | passthru                                               | none              | process the results of the above remote operation                                                                                                                                                         |
| FinalizeCardPair         | client | Run FinalizeCardPair                            | passthru                                               | FinalizeCardPair  | Run the FinalizeCardPair operation in the remote session and send back the results, and set the session to paired                                                                                         |
| FinalizeCardPairResponse | client | Process FinalizeCardPair Response               | passthru                                               | none              | process the results of the above remote operation and set the session to paired                                                                                                                           |
| RequestReceivePhonon     | Client | Receive encoded phonon                          | Cache request and passthru                             | receivePhonons    | Process the phonon packet from a paired session                                                                                                                                                           |


## How a transfer will generally happen
1. Once both cards are connected, they will both send a connectcard2card request to the server with a payload of the ID of the counterparty card. If both cards are connected and not connected to another card, they will be connected logically through the server, and all passthrough requests will be sent from one card to the peer. 

1. The card with the lower numbered ID will then start the pairing process by sending a cardpair1. They will go back and forth with the standard pairing process until the cards are paired. 

1. The sending card's session will verify the pairing and have the card run SendPhonons

1. A request to receive phonons with a payload of the phonon packet will be sent and cached by the server(unimplemented currently), and then passed through to to the other side's card where receivephonons is called. 

1. A Phonon Ack is sent back. When the server receives it, the cachedk phonon packet is deleted, and the sender can be reasonably sure the phonon has made it. 
